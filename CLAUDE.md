# CLAUDE.md — Developer & Agent Quick Reference

## What This Project Is

A PostgreSQL TLE (Trusted Language Extension) that provides multi-tenant RBAC for Supabase projects. Distributed via [database.dev](https://database.dev/pointsource/supabase_rbac) as `pointsource-supabase_rbac`. Current version: **5.0.0**.

## Repository Layout

```
supabase_rbac--5.0.0.sql       # Current extension full install script (READ THIS FIRST)
supabase_rbac--X.Y.Z.sql       # Prior version install scripts (keep for reference)
supabase_rbac.control          # Extension metadata (default_version lives here)
CHANGELOG.md                   # Version history

examples/
  policies/
    quickstart.sql             # Recommended starter RLS for rbac.* tables
    role_centric.sql           # Example RLS using role names (owner/admin/viewer)
    permission_centric.sql     # Example RLS using dot-notation permissions
    storage_rls.sql            # Storage RLS examples
    custom_table_isolation.sql # RLS for custom app tables with group_id FK
    hardened_setup.sql         # REVOKE ALL + targeted GRANT defense-in-depth
  triggers/
    auto_group_owner.sql       # Auto-assign owner on group create (superseded by create_group RPC)
    auto_group_permissions.sql # Auto-assign permissions on group create (superseded by create_group RPC)
    sync_user_into_group_role.sql  # Keep user email/name synced into members.metadata
    on_delete_user_roles.sql   # Cascade deletes via user_roles view
  views/
    user_roles.sql             # Flattened view: one row per user-group-role
  functions/
    add_user_by_email.sql      # Add user by email (superseded by add_member RPC)
  setup/
    remove_public_wrappers.sql # How to drop auto-created public.* wrappers

supabase/
  config.toml                  # Local dev config (Postgres 15, port 54321)
  migrations/
    20240502214827_install_pre_reqs.sql   # Installs pg_tle
    20240502214828_install_rbac.sql       # Installs extension in rbac schema
    20240502214829_add_dummy_data.sql     # Test sensitive_data table
    20240512101038_add_rls_policies.sql   # RLS on rbac tables + sensitive_data
  seed.sql                     # 2 test users, 3 groups, role definitions, member assignments
  functions/invite/index.ts    # Deno edge function for invite acceptance

docs/
  ARCHITECTURE.md              # End-to-end system design
  SECURITY.md                  # Security model and known limitations
  KNOWN_ISSUES.md              # All open GitHub issues with context

tools/
  generate_migration.sh        # Generates install migration from extension SQL + control file
  get_jwt.sh                   # Script to get a JWT for local dev testing
```

## Local Development

```bash
# Start local Supabase (Docker required)
supabase start

# Applies migrations + seed.sql automatically
# Studio available at http://localhost:54323
# API at http://localhost:54321
# DB at postgresql://postgres:postgres@localhost:54322/postgres

# Stop
supabase stop

# Reset (re-runs migrations + seed)
supabase db reset

# Run tests
supabase test db

# Get a JWT for a test user (for curl testing)
./tools/get_jwt.sh
```

### Test Users (from seed.sql)
| Email | Password | Notes |
|-------|----------|-------|
| `devuser@email.local` | `password` | Owner of RED group, viewer in BLUE |
| `invited@email.local` | `password` | Owner of BLUE group, viewer in GREEN |

## Extension Versioning

When making changes to the core extension:

1. Create `supabase_rbac--<new-version>.sql` — full install script for fresh installs
2. Create `supabase_rbac--<old>--<new>.sql` — upgrade path (ALTER/REPLACE only changed objects)
3. Update `default_version` in `supabase_rbac.control`
4. The migration is auto-regenerated by `tools/generate_migration.sh` (runs via hook)
5. Add entry to `CHANGELOG.md`

**Version bump rules:**
- `patch` (5.0.x): Bug fixes only
- `minor` (5.x.0): New features, backwards compatible
- `major` (x.0.0): Breaking changes

## Key Design Principles

- **Private schema**: Tables in `@extschema@` (e.g. `rbac`), NOT in PostgREST's exposed schemas. All access via RPCs.
- **Public wrappers**: When installed in non-`public` schema, thin `public.*` pass-through functions are auto-created for PostgREST RPC discovery and unqualified RLS policy calls.
- **Deny-all by default**: All tables have RLS enabled with zero policies. Consumers must add policies.
- **Fresh claims on every request**: `db_pre_request` reads `rbac.user_claims` on each API call.
- **Auth Hook**: `custom_access_token_hook` injects group claims into JWTs at token creation (optional, complements db_pre_request).
- **Role validation**: All role assignments validated against the `roles` table.
- **SECURITY INVOKER by default**: Management RPCs respect RLS. Only `create_group` and `accept_invite` are DEFINER (bootstrap operations).

## Core Tables (in `@extschema@`)

| Table | Purpose |
|-------|---------|
| `groups` | Tenants/orgs. Has `id`, `name`, `metadata`, timestamps |
| `members` | One row per membership. `group_id`, `user_id`, `roles text[]`, `metadata` |
| `invites` | Invite codes. `group_id`, `roles text[]`, `invited_by`, `expires_at` |
| `roles` | Global role definitions. `name text PK`, `description`. Pre-seeded with `'owner'` |
| `user_claims` | Claims cache. `user_id uuid PK`, `claims jsonb`. Auto-managed by trigger. |

## Core Functions

### RLS Helpers (use in policies)
- `has_role(group_id uuid, role text)` → boolean
- `is_member(group_id uuid)` → boolean
- `has_any_role(group_id uuid, roles text[])` → boolean
- `has_all_roles(group_id uuid, roles text[])` → boolean
- `get_claims()` → jsonb

### Management RPCs
- `create_group(p_name text, p_metadata jsonb, p_creator_roles text[])` → uuid [DEFINER]
- `delete_group(p_group_id uuid)` [INVOKER]
- `add_member(p_group_id uuid, p_user_id uuid, p_roles text[])` → uuid [INVOKER]
- `remove_member(p_group_id uuid, p_user_id uuid)` [INVOKER]
- `update_member_roles(p_group_id uuid, p_user_id uuid, p_roles text[])` [INVOKER]
- `list_members(p_group_id uuid)` → table [INVOKER]
- `accept_invite(p_invite_id uuid)` [DEFINER]
- `create_role(p_name text, p_description text)` [INVOKER]
- `delete_role(p_name text)` [INVOKER]
- `list_roles()` → table [INVOKER]

### Auth Hook
- `custom_access_token_hook(event jsonb)` → jsonb [INVOKER, supabase_auth_admin]

## File Relationships

```
members (INSERT/UPDATE/DELETE)
    └── trigger: on_change_sync_member_metadata
        └── calls: _sync_member_metadata()  [SECURITY INVOKER]
            └── upserts: rbac.user_claims

Every PostgREST API request:
    └── db_pre_request()  [SECURITY INVOKER, registered on authenticator role]
        └── reads: rbac.user_claims
        └── writes: request.groups (session config)

Token creation (Supabase Auth Hook):
    └── custom_access_token_hook()  [SECURITY INVOKER, supabase_auth_admin]
        └── reads: rbac.user_claims
        └── injects: claims.app_metadata.groups into JWT

RLS policies call:
    └── has_role(group_id, role)
    │   is_member(group_id)
    │   has_any_role(group_id, roles[])
    │   has_all_roles(group_id, roles[])
        └── calls: get_claims()
            └── reads: request.groups (from db_pre_request)
            └── fallback: _get_user_groups() [SECURITY INVOKER] (Storage path)
```

## Common Gotchas

- **RLS policies required**: The extension ships with zero RLS policies. You MUST add policies on `rbac.groups`, `rbac.members`, `rbac.invites`, and `rbac.roles` or nothing will work. See `examples/policies/quickstart.sql`.
- **Role validation**: All roles used in `create_group()`, `add_member()`, `update_member_roles()`, and invite `roles` arrays must exist in `rbac.roles`. Add them via `create_role()` or direct INSERT first.
- **Storage requests bypass db_pre_request**: `get_claims()` falls back to `_get_user_groups()` which reads `rbac.user_claims` directly, so Storage RLS still works.
- **user_claims is auto-managed**: Never write to `rbac.user_claims` directly. The trigger on `members` keeps it in sync. The table has RLS enabled (deny-all except for the defined roles).
- **TLE backup/restore**: Supabase logical backups may fail to restore if `auth.users` isn't available. See [Issue #41](https://github.com/point-source/supabase-tenant-rbac/issues/41).
